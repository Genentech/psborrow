---
title: "Demo for External Control Forum"
author: "Yichen Lu"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
        fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Simulation example for demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
remove(list = ls())
```


## Load the package

```{r, results = 'hide'}
library(psborrow)
library(survival)
```


## Set sample size and simulate covariates

```{r}
# Number of observations
ss = set_n(ssC = 140, ssE = 275, ssExt = 100)

# Set up covariates
covset1 = set_cov(n_cat = 2, n_cont = 0, mu_int = 0, mu_ext = 0, var = 1, cov = 0.5, 
                  prob_int = c(0.8, 0.6), prob_ext = c(0.7, 0.50))
```

$$\begin{aligned}
\begin{bmatrix}
X_1\\X_2\\
\end{bmatrix} 
&\sim N \left( \begin{bmatrix} 0\\ 0 \end{bmatrix},
\begin{bmatrix} 
1 & 0.5\\
0.5 & 1\\
\end{bmatrix} \right)
\\
\text{internal: Pr} (X_1 = 1) &= 0.8 \\
\text{Pr}(X_2 = 1) &= 0.6\\
\\
\text{external: Pr} (X_1 = 1) &= 0.7\\
P(X_2 = 1) &= 0.5\\
\end{aligned}$$

```{r}
# add continuous covariates
covset2 = set_cov(n_cat = 0, n_cont = 1, mu_int = 62, mu_ext = 65, var = 11^2)
```

$$\begin{aligned}
\text{internal } &X_3 \sim N (62, 11^2)\\
\text{external } &X_3 \sim N (65, 11^2)\\
\end{aligned}$$

```{r}
covset3 = set_cov(n_cat = 2, n_cont = 0, mu_int = 0, mu_ext = 0, var = 1, cov = 0.3, 
                  prob_int = c(0.4, 0.5), prob_ext = c(0.3, 0.6))
covset4 = set_cov(n_cat = 3, n_cont = 0, mu_int = 0, mu_ext = 0, var = 1, cov = 0.2, 
                  prob_int = c(0.9, 0.3, 0.1), prob_ext = c(0.8, 0.4, 0.1))

# combine all covariate settings
cov_list = c(covset1, covset3, covset4, covset2)
```

*HR*: hazard ratio between internal treatment and control arm

*driftHR*: hazard ratio between external and internal control arm

Calculate HR and driftHR based on median OS from exponential

- internal control: 51 month
- internal treatment: 76 months (HR = 0.67) or 51 months (HR = 1)
- external control: 51 months (driftHR = 1)

```{r, results='hide'}
# simulate indicator and covariates
sample_cov <- simu_cov(ssObj = ss, covObj = cov_list, HR = c(0.67, 1), driftHR = c(1), seed = 47, nsim = 2)
```


```{r}
head(sample_cov[[1]])
```


## Survival

### Time-to-event

```{r}
# calculate hazard rate with median OS from exponential = 51 months
log(2)/51

# lambdaC: baseline hazard rate for patients on the internal control arm with covaraites = 0
evt <- set_event(event = "pwexp", lambdaC = 0.0135, beta = c(1, 1, 0.5, rep(0.001, 5)))
```

```{r, eval = FALSE}
# time-to-event follows piece-wise exponential
set_event(event = "pwexp", lambdaC = c(0.0135, 0.02, 0.0135), t_itv = c(1, 5), beta = c(rep(0.001, 8)))
```


```{r, eval = FALSE}
# follow weibull
set_event(event = "weibull", shape = 0.9, lambdaC = 0.0135, beta = 0.001)
```

### Enrollment pattern, drop-out, analysis start time

Trial assumptions

- internal trial: recruitment rate = 10 patients per month, n = 140 + 275
- external trial: recruitment period: 18 months, n = 100
- drop out rate per year: 4% vs 1%
- censor events post 64 months after first patient in


```{r}
c_int = set_clin(gamma = 10, e_itv = 415/10, etaC = 0.04/12,  CCOD = "fixed-first", CCOD_t = 64)
c_ext = set_clin(gamma = 100/18, e_itv = 18, etaC = 0.01/12,  CCOD = "fixed-first", CCOD_t = 64)
```

```{r, eval = FALSE}
# time to start analysis driven by number of events
set_clin(gamma = 10, e_itv = 415/10, etaC = 0.01/12, CCOD = "event", CCOD_t = 200)
```

```{r, results='hide'}
# Simulate survival time and censor
sample_time <- simu_time(dt = sample_cov, eventObj = evt, clinInt = c_int, clinExt = c_ext, seed = 47)
```

```{r}
# two examples
head(sample_time[[1]])
head(sample_time[[4]])
```


### Kaplan-Meier Curves

```{r}
# KM plot
km_dt <- as.data.frame(sample_time[[1]])
km_dt$arm = ifelse(km_dt$ext == 1, "External control", 
                   ifelse(km_dt$trt == 0, "Internal control", "Internal treatment"))

fit <- survfit(Surv(time, 1-cnsr) ~ arm, data = km_dt)

plot(fit, mark.time=TRUE, mark=3, cex =0.5, col = c("purple", "#ee8c94", "#aed7e8"), xlim = c(0, 70),
     xlab="Month since randomization", ylab = "Survival", 
     main = "KM curves \n pre-specified HR = 0.67, driftHR = 1 \n")
legend(50, 1, legend = c("Internal control", "Internal treatment", "External control"),
       col=c("#ee8c94", "#aed7e8", "purple"), lty=1:1, cex=0.8)
```


## Bayesian analysis

```{r}
# use no predictors in the weibull model
# set borrowing method and initial values for the parameters
pr1 <- set_prior(pred = "none", prior = "cauchy", r0 = 1, alpha = c(0, 0), sigma = 0.03)
pr2 <- set_prior(pred = "none", prior = "gamma", r0 = 1, alpha = c(0, 0))
pr3 <- set_prior(pred = "none", prior = "no_ext", alpha = 0)
pr4 <- set_prior(pred = "none", prior = "full_ext", alpha = 0)
```

```{r, eval = FALSE}
# use covariates as predictors in the weibull model
set_prior(pred = c("cov1", "cov2"), prior = "cauchy", alpha = 0)
set_prior(pred = "all", prior = "gamma", alpha = 0)
```

```{r, results='hide'}
# combine all priors
pr_list <- c(pr1, pr2, pr3, pr4)

# run MCMC
res <- run_mcmc(dt = sample_time, pr_list, n.chains = 2, n.adapt = 100, n.burn = 100, n.iter = 100)
```

```{r}
head(res)
```

```{r, eval = FALSE}
# run MCMC in parallel
run_mcmc_p(dt = sample_time, pr_list, n.chains = 2, n.adapt = 100, n.burn = 100, n.iter = 100)
```


## Posterior summary statistics

```{r, echo = FALSE, include = FALSE, eval = FALSE}
load("~/psborrow/data/demo_exp.rda")
```

```{r}
summ <- get_summary(res_rbind)
head(summ)
plot_type1error(summ, driftHR = 1, pred = "none")
plot_power(summ, HR = 0.67, driftHR = 1, pred = "none")
plot_hr(summ, HR = 0.67, driftHR = 1, pred = "none")
plot_bias(summ, HR = 0.67, driftHR = 1, pred = "none")
plot_mse(summ, HR = 0.67, driftHR = 1, pred = "none")
```
