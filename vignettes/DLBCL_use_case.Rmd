---
title: "DLBCL use case"
author: "Yichen Lu"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
        fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Simulation example with DLBCL trials}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>", eval = TRUE, warning = FALSE, message = FALSE, echo = TRUE, cache = FALSE, results='hide'
, fig.height = 6, fig.width=8)
```



```{r setup, echo = FALSE}
library(psborrow)
```


The following code shows three use cases for the package (no covariates, with covariates, match before Bayes). For each use case, we only ran 2 simulations and a minimal number of iterations in the sampling phase to save time. As a consequence, the summary plots may not reflect the true outcome. Users are encouraged to increase the number of simulations in `simu_cov` and number of iterations in `run_mcmc` to get stable results.


## Use case 1: no covariates

```{r}
# Number of observations
ss = set_n(ssC = 140, ssE = 275, ssExt = 100)
sample_cov <- simu_cov(ssObj = ss, HR = c(0.67, 1), driftHR=c(1,1.2), nsim = 2)
# sample_cov <- simu_cov(ssObj = ss, HR = c(0.67, 1), driftHR=c(1,1.2,1.5,0.8,0.65), nsim = 100)

# Enrollment pattern, drop-out, analysis start time
c_int = set_clin(gamma = 10, e_itv = 415/10, etaC = -log(1-0.04/12),  CCOD = "fixed-first", CCOD_t = 64)
c_ext = set_clin(gamma = 100/18, e_itv = 18, etaC = -log(1-0.01/12),  CCOD = "fixed-first", CCOD_t = 64)

# Time-to-event distribution
evt <- set_event(event = "weibull", shape = 0.9, lambdaC = 0.0135)
sample_time <- simu_time(dt = sample_cov, eventObj = evt, clinInt = c_int, clinExt = c_ext)

# Predictors in the weibull distribution and prior distribution for the precision variable
pr1 <- set_prior(pred = "none", prior = "cauchy", r0 = 1, alpha = c(0, 0), sigma = 0.03)
pr2 <- set_prior(pred = "none", prior = "gamma", r0 = 1, alpha = c(0, 0))
pr3 <- set_prior(pred = "none", prior = "no_ext", alpha = 0)
pr4 <- set_prior(pred = "none", prior = "full_ext", alpha = 0)

pr_list <- c(pr1, pr2, pr3, pr4)
scenario_driftHR <- run_mcmc(dt = sample_time, pr_list, n.chains = 2, n.adapt = 100, n.burn = 100, n.iter = 200, seed = 46)
summ <- get_summary(scenario_driftHR)
plot_type1error(summ, driftHR = 1.2)
plot_power(summ)
```


## Use case 2: with covariates

```{r}
# Number of observations
ss = set_n(ssC = 140, ssE = 275, ssExt = 100)
covset1 = set_cov(n_cat = 2, n_cont = 0, mu_int = 0, mu_ext = 0, var = 1, cov = 0.5, 
                  prob_int = c(0.8, 0.6))
covset2 = set_cov(n_cat = 2, n_cont = 0, mu_int = 0, mu_ext = 0, var = 1, cov = 0.3, 
                  prob_int = c(0.4, 0.5), prob_ext = c(0.3, 0.6))
covset3 = set_cov(n_cat = 3, n_cont = 0, mu_int = 0, mu_ext = 0, var = 1, cov = 0.2, 
                  prob_int = c(0.9, 0.3, 0.1))
covset4 = set_cov(n_cat = 0, n_cont = 1, mu_int = 62, mu_ext = 65, var = 11^2)
cov_list = c(covset1, covset2, covset3, covset4)

sample_cov <- simu_cov(ssObj = ss, covObj = cov_list, HR = c(0.67, 1), driftHR = c(1), nsim = 2)

# Enrollment pattern, drop-out, analysis start time
c_int = set_clin(gamma = 10, e_itv = 415/10, etaC = -log(1-0.04/12),  CCOD = "fixed-first", CCOD_t = 64)
c_ext = set_clin(gamma = 100/18, e_itv = 18, etaC = -log(1-0.01/12),  CCOD = "fixed-first", CCOD_t = 64)

# Time-to-event distribution
evt <- set_event(event = "weibull", shape = 0.9, lambdaC = 0.0135, beta = c(1, 1, 0.5, rep(0.001, 5)))
sample_time <- simu_time(dt = sample_cov, eventObj = evt, clinInt = c_int, clinExt = c_ext)


# Predictors in the weibull distribution and prior distribution for the precision variable
pr1 <- set_prior(pred = "none", prior = "cauchy", r0 = 1, alpha = c(0, 0), sigma = 0.03)
pr2 <- set_prior(pred = "none", prior = "gamma", r0 = 1, alpha = c(0, 0))
pr3 <- set_prior(pred = "none", prior = "no_ext", alpha = 0)
pr4 <- set_prior(pred = "none", prior = "full_ext", alpha = 0)

pr_list <- c(pr1, pr2, pr3, pr4)

# parallel processing
scenario_cov <- run_mcmc_p(dt = sample_time, pr_list, n.chains = 2, n.adapt = 100, n.burn = 100, n.iter = 20, seed = 47)

summ <- get_summary(scenario_cov)
plot_hr(summ, driftHR = 1)
```



## Use case 3: match before Bayes

```{r}
# Number of observations
ss = set_n(ssC = 140, ssE = 275, ssExt = 100)
covset1 = set_cov(n_cat = 2, n_cont = 0, mu_int = 0, mu_ext = 0, var = 1, cov = 0.5, 
                  prob_int = c(0.8, 0.6))
covset2 = set_cov(n_cat = 0, n_cont = 1, mu_int = 62, mu_ext = 65, var = 11^2)
cov_list = c(covset1, covset2)

sample_cov <- simu_cov(ssObj = ss, covObj = cov_list, HR = 1, driftHR = 1.2, nsim = 2)
sample_match <- match_cov(dt = sample_cov, match = c("cov1", "cov2"))

# Enrollment pattern, drop-out, analysis start time
c_int = set_clin(gamma = 10, e_itv = 415/10, etaC = -log(1-0.04/12),  CCOD = "fixed-first", CCOD_t = 64)
c_ext = set_clin(gamma = 100/18, e_itv = 18, etaC = -log(1-0.01/12),  CCOD = "fixed-first", CCOD_t = 64)

# Time-to-event distribution
evt <- set_event(event = "weibull", shape = 0.9, lambdaC = 0.0135, beta = c(1, 1, 0.5, rep(0.001, 5)))
sample_time <- simu_time(dt = sample_match, eventObj = evt, clinInt = c_int, clinExt = c_ext)

# Predictors in the weibull distribution and prior distribution for the precision variable
pr1 <- set_prior(pred = "none", prior = "cauchy", r0 = 1, alpha = c(0, 0), sigma = 0.03)
pr2 <- set_prior(pred = "none", prior = "gamma", r0 = 1, alpha = c(0, 0))
pr3 <- set_prior(pred = "none", prior = "no_ext", alpha = 0)
pr4 <- set_prior(pred = "none", prior = "full_ext", alpha = 0)

pr_list <- c(pr1, pr2, pr3, pr4)
scenario_match <- run_mcmc_p(dt = sample_time, pr_list, n.chains = 2, n.adapt = 10, n.burn = 10, n.iter = 20, seed = 46)

summ <- get_summary(scenario_match)
plot_bias(summ, driftHR = 1.2, HR = 1)
plot_mse(summ, driftHR = 1.2, HR = 1)
```





