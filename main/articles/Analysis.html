<!DOCTYPE html>
<!-- Generated by pkgdown + https://github.com/insightsengineering/r-pkgdown-multiversion -->
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Analysing data with psborrow • psborrow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Analysing data with psborrow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">psborrow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Analysis.html">Analysing data with psborrow</a></li>
    <li><a class="dropdown-item" href="../articles/user_guide.html">User Guide: Dynamic Borrowing with psborrow</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      <div><li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-versions">Versions</a>
    <div class="dropdown-menu" aria-labelledby="dropdown-versions">
    <a class="dropdown-item" data-toggle="tooltip" title="" href="https://Genentech.github.io/psborrow/main">main</a>
</div>
</li></div>
</ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Analysing data with psborrow</h1>
            
      

      <div class="d-none name"><code>Analysis.Rmd</code></div>
    </div>

    
    
<p>This vignette provides additional details of the analysis model that
is fitted as well as a demonstration of how to use the package to fit
said models to an existing dataset. For examples of how to fit the
analysis model to the simulated datasets generated by the package
itself, please see the user-guide vignette.</p>
<p>The “Analysis Model” section of this vignette is a modified excerpt
from Lu, Y. et al. (2021).</p>
<div class="section level2">
<h2 id="analysis-model">Analysis Model<a class="anchor" aria-label="anchor" href="#analysis-model"></a>
</h2>
<p>The package uses Markov chain Monte Carlo (MCMC) through JAGS to
obtain the posterior distribution for the hazard ratio between treatment
and control arms. The package relies on the Bayesian commensurate prior
approach (Lewis, et al., 2019). The probability density function for the
survival time of patient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
following a Weibull model is as below:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub><mo>∼</mo><mi>W</mi><mi>e</mi><mi>i</mi><mi>b</mi><mi>u</mi><mi>l</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ν</mi><mo>,</mo><msub><mi>λ</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
t_i \sim Weibull( \nu, \lambda_i)
</annotation></semantics></math></p>
<p>for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">i = 1, 2, \dots,n</annotation></semantics></math>,
where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ν</mi><annotation encoding="application/x-tex">\nu</annotation></semantics></math>
is the shape parameter</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>
is the rate,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
is the total sample size of the analysis population.</li>
</ul>
<p>The probability density function is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mi>i</mi></msub><mo>,</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>ν</mi><msub><mi>λ</mi><mi>i</mi></msub><msup><mi>t</mi><mrow><mi>ν</mi><mo>−</mo><mn>1</mn></mrow></msup><msup><mi>e</mi><mrow><mi>−</mi><msub><mi>λ</mi><mi>i</mi></msub><msup><mi>t</mi><mi>ν</mi></msup></mrow></msup></mrow><annotation encoding="application/x-tex">
f(t_i, x_i) = \nu\lambda_i t^{\nu-1} e^{-\lambda_it^\nu}
</annotation></semantics></math></p>
<p>with the rate taking the format:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>i</mi></msub><mo>=</mo><mi>e</mi><mi>x</mi><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>α</mi><mi>i</mi></msub><mo>+</mo><msub><mi>β</mi><mrow><mi>t</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>×</mo><msub><mi>I</mi><mrow><mi>t</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>+</mo><msup><mi>β</mi><mi>T</mi></msup><mo>×</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\lambda_i = exp(\alpha_i + \beta_{trt}  \times I_{trt} + \beta^T \times X_{i})
</annotation></semantics></math></p>
<p>Where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>=</mo><msub><mi>α</mi><mrow><mi>c</mi><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_i = \alpha_{cc}</annotation></semantics></math>
if patient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
is in the concurrent trial, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>=</mo><msub><mi>α</mi><mrow><mi>e</mi><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_i = \alpha_{ec}</annotation></semantics></math>
if patient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
is in the external trial. Because the impact of therapy is captured by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mrow><mi>t</mi><mi>r</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">I_{trt}</annotation></semantics></math>
below,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mrow><mi>c</mi><mi>c</mi></mrow></msub><annotation encoding="application/x-tex">\alpha_{cc}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mrow><mi>e</mi><mi>c</mi></mrow></msub><annotation encoding="application/x-tex">\alpha_{ec}</annotation></semantics></math>
effectively correspond to the log of baseline hazard rate for concurrent
control arm and external control arm, respectively.</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mi>n</mi></msub><annotation encoding="application/x-tex">\beta_n</annotation></semantics></math>
is an n-length vector of regression coefficients<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mrow><mi>n</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">X_{ni}</annotation></semantics></math>
is an n-length covariate vector for patient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
including all additional parameters to adjust for (e.g. propensity
score).<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mrow><mi>t</mi><mi>r</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">I_{trt}</annotation></semantics></math>
is the treatment indicator (value equals to 0 or 1).</li>
</ul>
<p>A hierarchical model is defined in which the log hazard rate for the
concurrent controls is centered on the external controls, i.e.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>c</mi><mi>c</mi></mrow></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>α</mi><mrow><mi>e</mi><mi>c</mi></mrow></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>α</mi><mrow><mi>e</mi><mi>c</mi></mrow></msub><mo>,</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha_{cc} | \alpha_{ec} \sim N(\alpha_{ec}, \tau)</annotation></semantics></math>.
The hyperprior
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>,
also referred to as the commensurability parameter, determines the
extent of borrowing (see Lewis, et al., 2019).</p>
<p>Four borrowing methods have been implemented:</p>
<ol style="list-style-type: decimal">
<li>Not borrowing any external control information</li>
<li>Fully incorporating external control arm patients to the concurrent
control group</li>
<li>Dynamic borrowing with the commensurability hyperparameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
following a Gamma distribution</li>
<li>Dynamic borrowing with the commensurability hyperparameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
following a half-Cauchy distribution</li>
</ol>
<p>For methods (1) and (2), a conventional Bayesian model without
dynamic borrowing is deployed with all relevant parameters assigned a
non-informative prior. For method (1) no external control arm
information is used and as such
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>c</mi><mi>c</mi></mrow></msub><mo>=</mo><mi>α</mi><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>0.0001</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha_{cc} = \alpha \sim N(0, 0.0001)</annotation></semantics></math>
For method (2) the external control arm is treated as part of the
concurrent control and as such
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>c</mi><mi>c</mi></mrow></msub><mo>=</mo><msub><mi>α</mi><mrow><mi>e</mi><mi>c</mi></mrow></msub><mo>=</mo><mi>α</mi><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>0.0001</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha_{cc} = \alpha_{ec} = \alpha \sim N(0, 0.0001)</annotation></semantics></math>.</p>
<p>In comparison, methods (3) and (4) have the commensurability
hyper-parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>,
which acts as the precision variable assessing the similarity between
the concurrent and external control groups. The prior of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>a</mi><mi>u</mi></mrow><annotation encoding="application/x-tex">tau</annotation></semantics></math>
follows a Gamma distribution (default: shape = 1, rate = 0.001) and a
half-Cauchy distribution (default: location = 0, scale = 0.2),
respectively, in methods 3 and 4. Users can update the default values
for the parameter if they wish to customize the hyper-prior.</p>
<p>After users state the prior choices and the simulated data is ready
for use, the Markov chain Monte Carlo (MCMC) algorithm is deployed to
obtain samples from the posterior distribution.</p>
</div>
<div class="section level2">
<h2 id="example-of-use">Example of use<a class="anchor" aria-label="anchor" href="#example-of-use"></a>
</h2>
<p>To demonstrate how to use the package to fit the analysis model we
first generate a dataset where the time to event is drawn from the
following distribution:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub><mo>∼</mo><mi>W</mi><mi>e</mi><mi>i</mi><mi>b</mi><mi>u</mi><mi>l</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0.95</mn><mo>,</mo><msub><mi>λ</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
t_i \sim Weibull(0.95, \lambda_i)
</annotation></semantics></math> Where:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mn>150</mn></mfrac><msub><mi>I</mi><mrow><mi>e</mi><mi>c</mi></mrow></msub><mo>×</mo><mfrac><mn>1</mn><mn>200</mn></mfrac><msub><mi>I</mi><mrow><mi>c</mi><mi>c</mi></mrow></msub><mo>×</mo><mfrac><mn>1</mn><mn>400</mn></mfrac><msub><mi>I</mi><mrow><mi>t</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>×</mo><mi>e</mi><mi>x</mi><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0.2</mn><mo>×</mo><msub><mi>x</mi><mrow><mi>a</mi><mi>g</mi><mi>e</mi></mrow></msub><mo>−</mo><mn>0.1</mn><mo>×</mo><msub><mi>I</mi><mrow><mi>f</mi><mi>e</mi><mi>m</mi><mi>a</mi><mi>l</mi><mi>e</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\lambda_i =  \frac{1}{150}I_{ec} \times \frac{1}{200}I_{cc} \times \frac{1}{400}I_{trt} \times
exp(0.2\times x_{age} - 0.1\times I_{female})
</annotation></semantics></math></p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mrow><mi>e</mi><mi>c</mi></mrow></msub><annotation encoding="application/x-tex">I_{ec}</annotation></semantics></math>
is 1 if the patient is in the external trial else 0<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mrow><mi>c</mi><mi>c</mi></mrow></msub><annotation encoding="application/x-tex">I_{cc}</annotation></semantics></math>
is 1 if the patient is in the concurrent trial else 0<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mrow><mi>t</mi><mi>r</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">I_{trt}</annotation></semantics></math>
is 1 if the patient is in the treatment arm else 0<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mrow><mi>f</mi><mi>e</mi><mi>m</mi><mi>a</mi><mi>l</mi><mi>e</mi></mrow></msub><annotation encoding="application/x-tex">I_{female}</annotation></semantics></math>
is 1 if the patient is female else 0<br>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mrow><mi>a</mi><mi>g</mi><mi>e</mi></mrow></msub><annotation encoding="application/x-tex">x_{age}</annotation></semantics></math>
is the patient’s age</li>
</ul>
<p>Patients are then censored by drawing a censoring time from the
exponential distribution with a rate parameter of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>1</mn><mi>/</mi><mn>400</mn></mrow><annotation encoding="application/x-tex">\lambda = 1/400</annotation></semantics></math></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">psborrow</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/flexsurv" class="external-link">flexsurv</a></span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">401</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="va">grp_lvl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CC"</span>, <span class="st">"TRT"</span>, <span class="st">"EC"</span><span class="op">)</span></span>
<span><span class="va">sex_lvl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_hr_grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"TRT"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">400</span><span class="op">)</span>,</span>
<span>    <span class="st">"CC"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">200</span><span class="op">)</span>,</span>
<span>    <span class="st">"EC"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">150</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_hr_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Male"</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="st">"Female"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_hr_age</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span></span>
<span><span class="va">Shape</span> <span class="op">&lt;-</span> <span class="fl">0.95</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    pt <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>    grp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">grp_lvl</span>, size <span class="op">=</span> <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        levels <span class="op">=</span> <span class="va">grp_lvl</span></span>
<span>    <span class="op">)</span>,</span>
<span>    sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">sex_lvl</span>, size <span class="op">=</span> <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        levels <span class="op">=</span> <span class="va">sex_lvl</span></span>
<span>    <span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span></span>
<span>        <span class="va">log_hr_age</span> <span class="op">*</span> <span class="va">age</span> <span class="op">+</span></span>
<span>        <span class="va">log_hr_sex</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span></span>
<span>        <span class="va">log_hr_grp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">grp</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="http://chjackson.github.io/flexsurv-dev/reference/WeibullPH.html" class="external-link">rweibullPH</a></span><span class="op">(</span><span class="va">n</span>, scale <span class="op">=</span> <span class="va">lambda</span>, shape <span class="op">=</span> <span class="va">Shape</span><span class="op">)</span>,</span>
<span>    centime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fl">400</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>event <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">centime</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">centime</span>, <span class="va">time</span>, <span class="va">centime</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pt</span>, <span class="va">grp</span>, <span class="va">age</span>, <span class="va">sex</span>, <span class="va">time</span>, <span class="va">event</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,000 × 6</span></span></span>
<span><span class="co">#&gt;       pt grp      age sex     time event</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 TRT    1.12  Female  64.0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 CC    -<span style="color: #BB0000;">0.577</span> Female  14.3     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 CC    -<span style="color: #BB0000;">0.281</span> Female 190.      0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 CC    -<span style="color: #BB0000;">0.371</span> Male   348.      0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 CC     1.29  Female  43.6     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 EC    -<span style="color: #BB0000;">0.840</span> Male    27.8     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 EC     0.901 Female 706.      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 TRT    0.906 Female 105.      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 CC     1.43  Male    57.9     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 TRT    2.75  Female  85.9     1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 990 more rows</span></span></span></code></pre></div>
<p>To conduct an analysis we need to use the <code><a href="../reference/apply_mcmc.html">apply_mcmc()</a></code>
function. However to use this function we first need to convert our data
into the required format. Full details of the required format can be
found in <code><a href="../reference/apply_mcmc.html">help(apply_mcmc)</a></code> however an example of this is
shown below:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat2</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">grp</span> <span class="op">==</span> <span class="st">"TRT"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ext <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">grp</span> <span class="op">==</span> <span class="st">"EC"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cnsr <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">event</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pt</span>, <span class="va">trt</span>, <span class="va">ext</span>, <span class="va">time</span>, <span class="va">cnsr</span>, <span class="va">sex</span>, <span class="va">age</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat2</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,000 × 7</span></span></span>
<span><span class="co">#&gt;       pt   trt   ext  time  cnsr sex       age</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1     1     0  64.0     0 Female  1.12 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2     0     0  14.3     1 Female -<span style="color: #BB0000;">0.577</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3     0     0 190.      1 Female -<span style="color: #BB0000;">0.281</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4     0     0 348.      1 Male   -<span style="color: #BB0000;">0.371</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5     0     0  43.6     0 Female  1.29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6     0     1  27.8     1 Male   -<span style="color: #BB0000;">0.840</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7     0     1 706.      0 Female  0.901</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8     1     0 105.      0 Female  0.906</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9     0     0  57.9     0 Male    1.43 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10     1     0  85.9     0 Female  2.75 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 990 more rows</span></span></span></code></pre></div>
<p>We can now pass our data to <code><a href="../reference/apply_mcmc.html">apply_mcmc()</a></code> to produce our
posterior samples. Prior distributions are specified using the
<code><a href="../reference/set_prior.html">set_prior()</a></code> function, details for which can be found in
<code><a href="../reference/set_prior.html">help(set_prior)</a></code> as well as the user-guide vignette.
Covariates for the analysis model need to be specified by a 1-sided
formula provided to the <code>formula_cov</code> argument. Note that the
treatment indicator is automatically added to the model and should not
be specified in the covariate formula; if you require treatment
interactions these should be specified explicitly via
<code>trt:cov</code> rather than by <code>trt*cov</code>. The intercept
term must always be included in this formula. You are advised to leave
the <code>pred</code> parameter as either “all” or “ps” depending on
your requirements. If you do wish to restrict the covariates included in
the model then this should be done by omitting them from the
<code>formula_cov</code> rather than the <code>pred</code> argument in
<code><a href="../reference/set_prior.html">set_prior()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">postsamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_mcmc.html">apply_mcmc</a></span><span class="op">(</span></span>
<span>    dt <span class="op">=</span> <span class="va">dat2</span>,</span>
<span>    formula_cov <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span>,</span>
<span>    priorObj <span class="op">=</span> <span class="fu"><a href="../reference/set_prior.html">set_prior</a></span><span class="op">(</span>pred <span class="op">=</span> <span class="st">"all"</span>, prior <span class="op">=</span> <span class="st">"gamma"</span>, r0 <span class="op">=</span> <span class="fl">0.85</span>, alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    n.chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    n.adapt <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    n.burn <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    n.iter <span class="op">=</span> <span class="fl">200</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">47</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Input all is found in pred. Any other input is disregarded.</span></span></code></pre></div>
<p>From here we can extract our posterior samples as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/apply_mcmc.html">extract_samples</a></span><span class="op">(</span><span class="va">postsamp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       HR_cc_hc HR_trt_cc  alpha[1]  alpha[2]   beta_trt  beta_age</span></span>
<span><span class="co">#&gt; [1,] 1.1096928 0.3671814 -4.949371 -4.845288 -1.0018994 0.2745032</span></span>
<span><span class="co">#&gt; [2,] 1.0268710 0.4697018 -4.876703 -4.850186 -0.7556573 0.2539210</span></span>
<span><span class="co">#&gt; [3,] 1.0575392 0.3991505 -4.942033 -4.886088 -0.9184167 0.3249545</span></span>
<span><span class="co">#&gt; [4,] 1.0205880 0.4088358 -4.897589 -4.877210 -0.8944417 0.2851334</span></span>
<span><span class="co">#&gt; [5,] 0.9857758 0.3605800 -4.859848 -4.874174 -1.0200414 0.2935454</span></span>
<span><span class="co">#&gt; [6,] 0.9864785 0.3633342 -4.903234 -4.916847 -1.0124321 0.2535249</span></span>
<span><span class="co">#&gt;      beta_sexFemale        r0       tau</span></span>
<span><span class="co">#&gt; [1,]    -0.25909116 0.9201647  360.0789</span></span>
<span><span class="co">#&gt; [2,]    -0.25321051 0.9204208  283.2014</span></span>
<span><span class="co">#&gt; [3,]    -0.22758668 0.9211114  667.9504</span></span>
<span><span class="co">#&gt; [4,]    -0.16777557 0.9215409 2315.9094</span></span>
<span><span class="co">#&gt; [5,]    -0.18770880 0.9191615 2675.4973</span></span>
<span><span class="co">#&gt; [6,]    -0.09992967 0.9020110  783.1036</span></span></code></pre></div>
<p>For reference the returned parameters are:</p>
<ul>
<li><p><code>HR_cc_hc</code> - The hazard ratio between the historical
control arm and the concurrent control arm. This can be be thought of as
the ratio of the scale parameter between the baseline external control
distribution and the baseline trial distribution. This is equivalent to
<code>exp(alpha[2] - alpha[1])</code></p></li>
<li><p><code>HR_trt_cc</code> - The hazard ratio between the treatment
arm and the concurrent control arm. This is equivalent to
<code>exp(beta_trt)</code></p></li>
<li><p><code>alpha[1]</code> - The shape parameter for the trial’s
baseline distribution</p></li>
<li><p><code>alpha[2]</code> - The shape parameter for the historical
control’s baseline distribution</p></li>
<li><p><code>beta_trt</code> - The log-hazard ratio for the treatment
effect. This is equivalent to <code>log(HR_trt_cc)</code></p></li>
<li><p><code>beta_age</code> - The log-hazard ratio for the covariate
<code>age</code></p></li>
<li><p><code>beta_sexFemale</code> - The log-hazard ratio for the
covariate <code>sexFemale</code></p></li>
<li><p><code>r0</code> - The scale parameter for the baseline
distribution of both the trial and the historical control</p></li>
<li><p><code>tau/sigma</code> - The precision/variance for
<code>alpha[1]</code> i.e. controls how much information is borrowed
from the historical control arm</p></li>
</ul>
<p>If <code>prior = "no_ext"</code> or <code>prior = "full_ext"</code>
then <code>alpha[1]</code> and <code>alpha[2]</code> will be replaced
with a single parameter <code>alpha</code> representing the shape
parameter for the single baseline distribution for the trail.</p>
<p>Additionally general summary statistics of our samples can be
generated by the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">postsamp</span><span class="op">)</span></span>
<span><span class="co">#&gt;        parameter         mean           sd        lci           uci</span></span>
<span><span class="co">#&gt; 1       HR_cc_hc    1.0112903   0.03767595  0.9401316    1.09642467</span></span>
<span><span class="co">#&gt; 2      HR_trt_cc    0.3857669   0.03881582  0.3230326    0.46980137</span></span>
<span><span class="co">#&gt; 3       alpha[1]   -4.9414910   0.09106815 -5.0775808   -4.76802672</span></span>
<span><span class="co">#&gt; 4       alpha[2]   -4.9309512   0.08729994 -5.0899134   -4.75289074</span></span>
<span><span class="co">#&gt; 5       beta_trt   -0.9573926   0.09823656 -1.1300021   -0.75544616</span></span>
<span><span class="co">#&gt; 6       beta_age    0.2781143   0.04180654  0.2019639    0.35759578</span></span>
<span><span class="co">#&gt; 7 beta_sexFemale   -0.1390660   0.07769175 -0.2664242    0.02923811</span></span>
<span><span class="co">#&gt; 8             r0    0.9239697   0.01768511  0.8921297    0.95277956</span></span>
<span><span class="co">#&gt; 9            tau 1002.0669283 999.10913348 49.5932394 3564.40952449</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Lu, Y., Lin, A., Pang, H., Zhu, J. (2021). PSBORROW: BAYESIAN
DYNAMIC BORROWING R TOOL FOR COMPLEX INNOVATIVE TRIAL DESIGNS. ASA
Biopharmaceutical Report, 28 (3), 11-19.</p></li>
<li><p>Lewis, C. J., Sarkar, S., Zhu, J., &amp; Carlin, B. P. (2019).
Borrowing from historical control data in cancer drug development: a
cautionary tale and practical guidelines. Statistics in
biopharmaceutical research, 11(1), 67-78.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Isaac Gravestock, Craig Gower-Page, Yichen Lu, Aijing Lin, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
